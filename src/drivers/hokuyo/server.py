from math import sin
import socket
import struct
import fastcrc
import time

SERVER_IP = '0.0.0.0'
SERVER_PORT = 10940

CMD_TOT_LEN = 14
CMD_FORMAT = 'c 4s 2s 2s 4s c'

STX = '\x02'
ETX = '\x03'

def UAM_decode(bytes):
    string = bytes.decode()
    decimal_res = []
    for i in range(0, len(string), 4):
        ascii = [ord(c) for c in string[i:i+4]]
        ascii_d = [c-0x30 if c<0x40 else c-0x37 for c in ascii]
        binary = ''.join([format(d, '04b') for d in ascii_d])
        decimal_res.append(int(binary, 2))
    return decimal_res

def UAM_encode(decimal_list):
    ascii_str = ''
    for decimal in decimal_list:
        binary = format(decimal, '016b')
        decimal = [int(binary[i:i+4], 2) for i in range(0, 16, 4)]
        ascii_d = [d+0x30 if d<10 else d+0x37 for d in decimal]
        ascii_str += ''.join([chr(a) for a in ascii_d])
    return ascii_str.encode()

def calc_crc(bytes):
    crc16 = fastcrc.crc16.kermit(bytes)
    return str(hex(crc16))[2:].upper().encode()

sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
server_address = (SERVER_IP, SERVER_PORT)

print(f'Starting server on {server_address}')
sock.bind(server_address)

sock.listen()

while True:

    # Wait for a connection
    print('waiting for a connection')
    connection, client_address = sock.accept()

    try:
        print('connection from', client_address)
        while True:
            # Receive the command
            data = connection.recv(CMD_TOT_LEN)
            s = struct.Struct(CMD_FORMAT)
            try:
                _, cmd_size, header, sub_header, crc, _ = s.unpack(data)
                print(cmd_size, header, sub_header, crc)

                if header + sub_header == b'AR01':
                    # Build data from sensor readings
                    msg_len = b'21FF'
                    area_num = b'07'
                    timestamp = b'005A2F4F'
                    # Example from sensor:
                    # data = b'030202FA02F702F402F002E302D502D602DC02E202E402E202E202E602E602D902D502CF0296029202880282027F027C027A027A027A027A02790282028A02A102A902A4029F02A102A102A902A502A502A2029E0270027002960296029502700268026B02650265026502650264025F025F025F025F025A025A0255025602560256024F024F024D024D024D024E0259025D02650266025E024202420242023E023E0240023E023E02400240023D023A02370237023702350230023502350237023302330233023302330235023F024A025102510250024C024A024702420240023B021B01F10184017C0184019701E501FF021B021F02220223021E021E022E023102360237023B023902360236023502260224021B01CA016F01640160015D015D015D015B015B0159015901590159015D0166016F0171017501740174017501750174017401740176017601780177017401740179017601730176017601760176017801780174017401700174017401790179017901790173016F016C016E017501760177017A017A017A01780178017A017D01720171017201760176017601700167015F016701690169016F016F016D016F016F0170016C0170017701B302090225021D01FA01FA0227023A023A02390239024202420247024002430243024302430249024802480248024A024D024D0251024F024F024F024F0250025002500250025002530253025502580258025A025E025E025E025E02610260025D025D0263026302630268026D026B026B026B027002700270026D026D027202700272027202750276027E027E027F027F0282028402910291029202920298029E02A602A6029E029E029E02A702AC02AA02AA02AB02B402B402B802B802BA02BE02BE02BE02BF02CA02C502C502CD02D602D502D202D202DE02DC02DE02E702E702EB02EB02F102F602F602FC02FE02FE030203060307030D030C031003100310031B031B031E03240327032C032E032F0333033A033A034003410346034A03500355035B035E035E0368037003710375037E037E037E037F03870388038D0394039403A303A303A403A303A30397037F03A503C103C503D403D403DF03E403EA03EA03EA0393039303F103F303EE03E003CF03CB03C603C503CB03E50411042304450457043003EA03F30477048B049304A604AC04BB04C304D204E0040B02AE028702C1057F0594050B04D40443034802ED02D2021F01DA01D801DD023D03180377042204DA04C704D204BA04B704BF04A804AE04A00497047C041F034703290324030102D902D602DC02F903000300024D01BB01B901CB02E002F4029C020C020A020902090231035803B104250484043C042A04B0058705B705CF05C005A805870586058B059505B405B005A105A00588055304B7046D046D0333031F032C032B032B0316030402EA02E702CF02CF02CF02CD02CD02BC02BC029502950295028A028A028A028B02710288026C025602520255025902560240022F022F022F0222022C022F022F0222022102210213021302130213020E0209020302030202020502010207020702050201020101FF01FD01FA01FC01F601FC01FC01FA01F601FA01FB01FB020201FC01FD01FD020201F601FA01FC02020207020702090206020B0203020B020B020B020B021002170217021C02210221022402240228022D022F022F0234023402360239023C023C023F0244024E024E024E0252025602630265026A02830289029B02AB02B102B702B402B802C702C802DE02E402E302F002F202F002E802EF02EF02F102F302F902FB0304030403040306030B030B030F03140315031F03220321033603650B1C0B200B290B300B370B3F0B4D0B540B580B6B0B760B7C0B820B8F0B9A0BA90BB30BBF0BCD0BD60BD90BE80BF20BFF0C0B0C130C200C370C3E0C410C540C590C5B0C730C810C8E0C9E0CA30CB00CC50CCC0CE10CE90CF70D020D150D210D300D410D500D680D680D810D8A0D980DAB0DBE0DC50DDD0DF40E0A0E160E250E340E4A0E5B0E6D0EA50EB50ED10ED90EE50EFB0F0F0F210F310F4C0F620F970F970F880F890F8B0F860F760F6A0F720F930FA80FC90FD10FEF100B102A105010611085109F10B310B31B5D1B5719281956197F19A91A011AE21B872B202B111A6F1A381A1819FC1A0019F019D319DD19B4199F198619861980196B195E195A1944193B191B1919190618FE18EB18E618E61929197B19C919E31A481B3B1B48FFFEFFFEFFFEFFFEFFFE1DF81E101E1A1E581EC81EF51F35254622A7227A2280229122B122DB233E23A32650263D265D265626CB26D226C826B726A6268B2685267B267626612653264026362620261A25FE25FA25F425E925DF25D425CA25C025AF25AB259F2591258625862582257A1A201A291A5A1A7E1A921AC31ADC1AF31B051B131B1E1B1C251F251F25150A2F0A210A0909F609F309F409FA09FB0A000A0A0A0F0A120A120A160B300DA40DA90DB30DBF0DA809F90A78177D1778177E17751772177C1770176F1778FFFEFFFE24831837250924F51C721AB7129A124A1199110510530FD10F740EEF0E8A0E0F0DAB0D470CF90CA80BD60C1C179B1792179217961799179F17A017A917C317F417FB18C6196B196B1A250921093626722675267209100900268726BB26DF26F227002712272A273B275227612779279527A427C727D927E2280C2820283F2851286E283A2833FFFEFFFEFFFEFFFE22692269225922452245225C276E26DC26B42693267D2669265026352618260025E829DFFFFEFFFEFFFEFFFEFFFEFFFE289A1DAA1D321CF81CB41C891C441C231C201C1C1C2C1C371C5E1CF407E9080007F107F507FF07EF07F407F707FA07F607EE07EB07E607E807E207E707E207DF07E607EA07E307DF07DA07D807D407E307DB07D107CD07D107CF07C707C707D107C207CB07BF07BC07C107B807B107AD07AC07AC07AF07A207A907AD07A907A207A407A207A207A607A30796079A079B079B079907A0079708C0084008E008C007B007E008780880089008C008F008B808A80848084805D004600378024802400258024802480250023001400128012801380170019802D80458046004B004F804F805E00898089808F808580468046807A807A808B807F8082008380838083808380840085008500850085808500858087008780880087808900898089808A808A807F008C807B8080808780A9009880888089008900878087808880868086808600850084008380818081808180800080007B007B007900798079807A807A807A00730078809480B400B400B400998099809400950094806B8045803D004580460045803F803B803A8039803C003D8037002F002F0037803380838091808F80928093009300908092808F807A004B804D804700458045804580458045804580458045804780478048804E00560060805B0074007401018101813281328137813D013D01450155814C014C01648170815F81830183019781958198019801870187016C816601660161813C813C812A8120810100F200E100DC80DF00CB00D800B000B000AA80AA80B200AA00880057005800870087008580850045804600458043804380420041804080410041004200420042004680720095809C808D806C806C809300A480A480A800A800A700A600A700A700A700A880A800A800A880A900A900A980A880A980AA00AB00A980A980AA00AA00AA00AA00AB00AB80AB80AC00AB80AC00AC80AD00AD00AE00AE00AE80AE00AD00AE80AE00AD00AE00AE80AE80AE80AD80AF00AF00AE00AE00AE00AF00AE80AE80AE00AD80AD00AD00AC80AC80AC80AC80AD80AD80AC80AC80AC80AC80AD80AD80AE00AD80AD00AE00AF00AF00AF00B080B000B200B200B280B600B600B180B180B100B080B080B200B580B580B700B700B680B700B800B800B800B780B800B780B780B780B680B700B600B700B700B700B600B600B700B600B580B580B680B480B500B500B400B600B500B480B300B380B480B380B380B500B500B300B300B380B400B380B280B280B280B280B300B280B200B100B080B180B100AE80AF00AF00AD80AE80AE80AD00AD00AC809700970044003B0042006C808A00A700A700A500A480A280A2809700618061806F806C80760061004F804A8047004400428045804880528059805D804A804B80588084808A00890084807D007F006F807480558059005D006180648058004A804A004A0064806E00680068006F006C00640064805D00620065005C8057003F003D803D003C803D003D803C803D003C803D003D003D803E004100430047003A002A802800270027002D8039003C8037002A002B803000440050005A805A803B8032803F8043803E803B003600360048804780388041804780748059804800478040804C008680850079005E004A804B004B007800B88057805380538050004F8056004F004E804E804E8058805E0054005400568056805C806480648064806F007880658070005D005F006480728067805700560056004F804E806380598065805B806480648060005F806300630077808100690069006780600065006F006D807300740074006E00828073808600888085808580798078007980750075007B8087008880888079807180700074007A00788079807780778077807C007C007C007D007D807A007C807E807C807D807D807F807F807F007E007C807C807E807E807780778075807400720071806E806D006D006A80670064806380568053805280590078808A008B808900898087807D809980940098008A8086008A808880958095809D00A000A080A400A780A800A780A780A600A600A480A380A40096809C808E0079007A004680468046804680468047004600460047004700470047804680480047804680470047004780478046004700470046804680470047004700470046804600468046804680460045804480448044004380440042804280418041804100408040003F803F8040803F803E803F003E003E003E003E003D003D803D803D803D803D003D003D003D804380470045004480438044004380438043804380438046004600458046004400440043804280400040004080400040003F803F003F003E003E003E003D80168016801E8020802B00268012000D8019802B801E8029802C00240028002700268029802A8028802B802B802A802B002A802A802C002C802F003000318032803380340033803580350035002E00290026802400270034801280000000000000000000003180330031802D802300210018001D002D803500348036802F002B802B002A80300031802F002E80360036003600368035803600358036803600368037003700378037003700370034803800380038003780378037803800378037803800378037803800388035803800340034002500300036803780380039003A0026003780378037003F803E80410056004D804E004D804E004E0073804C004C004C004B804B8036803400310030803000468011002A802B002C002A0029802880280027802B000000000019002A802480118013803B003400108013800A800C000E80150016801880140013801B80138016803F001F003B00370037003A803B003B0038803900360039803A804080218021801C801C002B00370037003700328043802900380039803A0039803A00398039803980390038803880380037003680358037003780378037003880318033000000000000000000248024803500360036002D001A801E801D801E801E001F00208020802000208020002D800000000000000000000000002C801000330037003680378038803B803C003B003A803A803500278015001B80270029002A802C002D002F80318032003380348035003500360037003800388039803A003B003C003C003C803D803E003E804000400041004180418042804280430043004400448044804500458046004580458046804680468046004680458045804580450045004600458046804700470047004880460'
                    t1 = time.perf_counter()
                    data = UAM_encode([int(sin(time.perf_counter()*5 - i/40)*1000+1000) for i in range(1081)]+[0]*1081)
                    print(len(data))
                    t2 = time.perf_counter()
                    UAM_msg = msg_len + b'AR01000' + area_num + b'11701111000000000000' + timestamp + b'00000000' + data
                    UAM_crc = calc_crc(UAM_msg)
                    t3 = time.perf_counter()
                    UAM_msg = b'\x02' + UAM_msg + UAM_crc + b'\x03'
                    connection.send(UAM_msg)
                    t4 = time.perf_counter()
                    # print(t1, t2-t1, t3-t2, t4-t3)

                    time.sleep(0.03)

                    # connection.send(b'\x0221FFAR010000711701111000000000000005A2F4F00000000030202FA02F702F402F002E302D502D602DC02E202E402E202E202E602E602D902D502CF0296029202880282027F027C027A027A027A027A02790282028A02A102A902A4029F02A102A102A902A502A502A2029E0270027002960296029502700268026B02650265026502650264025F025F025F025F025A025A0255025602560256024F024F024D024D024D024E0259025D02650266025E024202420242023E023E0240023E023E02400240023D023A02370237023702350230023502350237023302330233023302330235023F024A025102510250024C024A024702420240023B021B01F10184017C0184019701E501FF021B021F02220223021E021E022E023102360237023B023902360236023502260224021B01CA016F01640160015D015D015D015B015B0159015901590159015D0166016F0171017501740174017501750174017401740176017601780177017401740179017601730176017601760176017801780174017401700174017401790179017901790173016F016C016E017501760177017A017A017A01780178017A017D01720171017201760176017601700167015F016701690169016F016F016D016F016F0170016C0170017701B302090225021D01FA01FA0227023A023A0239023902420242024702400243024302430243024902')
                    # connection.send(b'4802480248024A024D024D0251024F024F024F024F0250025002500250025002530253025502580258025A025E025E025E025E02610260025D025D0263026302630268026D026B026B026B027002700270026D026D027202700272027202750276027E027E027F027F0282028402910291029202920298029E02A602A6029E029E029E02A702AC02AA02AA02AB02B402B402B802B802BA02BE02BE02BE02BF02CA02C502C502CD02D602D502D202D202DE02DC02DE02E702E702EB02EB02F102F602F602FC02FE02FE030203060307030D030C031003100310031B031B031E03240327032C032E032F0333033A033A034003410346034A03500355035B035E035E0368037003710375037E037E037E037F03870388038D0394039403A303A303A403A303A30397037F03A503C103C503D403D403DF03E403EA03EA03EA0393039303F103F303EE03E003CF03CB03C603C503CB03E50411042304450457043003EA03F30477048B049304A604AC04BB04C304D204E0040B02AE028702C1057F0594050B04D40443034802ED02D2021F01DA01D801DD023D03180377042204DA04C704D204BA04B704BF04A804AE04A00497047C041F034703290324030102D902D602DC02F903000300024D01BB01B901CB02E002F4029C020C020A020902090231035803B104250484043C042A04B0058705B705CF05C005A805870586058B05')
                    # connection.send(b'9505B405B005A105A00588055304B7046D046D0333031F032C032B032B0316030402EA02E702CF02CF02CF02CD02CD02BC02BC029502950295028A028A028A028B02710288026C025602520255025902560240022F022F022F0222022C022F022F0222022102210213021302130213020E0209020302030202020502010207020702050201020101FF01FD01FA01FC01F601FC01FC01FA01F601FA01FB01FB020201FC01FD01FD020201F601FA01FC02020207020702090206020B0203020B020B020B020B021002170217021C02210221022402240228022D022F022F0234023402360239023C023C023F0244024E024E024E0252025602630265026A02830289029B02AB02B102B702B402B802C702C802DE02E402E302F002F202F002E802EF02EF02F102F302F902FB0304030403040306030B030B030F03140315031F03220321033603650B1C0B200B290B300B370B3F0B4D0B540B580B6B0B760B7C0B820B8F0B9A0BA90BB30BBF0BCD0BD60BD90BE80BF20BFF0C0B0C130C200C370C3E0C410C540C590C5B0C730C810C8E0C9E0CA30CB00CC50CCC0CE10CE90CF70D020D150D210D300D410D500D680D680D810D8A0D980DAB0DBE0DC50DDD0DF40E0A0E160E250E340E4A0E5B0E6D0EA50EB50ED10ED90EE50EFB0F0F0F210F310F4C0F620F970F970F880F890F8B0F860F760F6A0F720F930FA80FC90FD10FEF10')
                    # connection.send(b'0B102A105010611085109F10B310B31B5D1B5719281956197F19A91A011AE21B872B202B111A6F1A381A1819FC1A0019F019D319DD19B4199F198619861980196B195E195A1944193B191B1919190618FE18EB18E618E61929197B19C919E31A481B3B1B48FFFEFFFEFFFEFFFEFFFE1DF81E101E1A1E581EC81EF51F35254622A7227A2280229122B122DB233E23A32650263D265D265626CB26D226C826B726A6268B2685267B267626612653264026362620261A25FE25FA25F425E925DF25D425CA25C025AF25AB259F2591258625862582257A1A201A291A5A1A7E1A921AC31ADC1AF31B051B131B1E1B1C251F251F25150A2F0A210A0909F609F309F409FA09FB0A000A0A0A0F0A120A120A160B300DA40DA90DB30DBF0DA809F90A78177D1778177E17751772177C1770176F1778FFFEFFFE24831837250924F51C721AB7129A124A1199110510530FD10F740EEF0E8A0E0F0DAB0D470CF90CA80BD60C1C179B1792179217961799179F17A017A917C317F417FB18C6196B196B1A250921093626722675267209100900268726BB26DF26F227002712272A273B275227612779279527A427C727D927E2280C2820283F2851286E283A2833FFFEFFFEFFFEFFFE22692269225922452245225C276E26DC26B42693267D2669265026352618260025E829DFFFFEFFFEFFFEFFFEFFFEFFFE289A1DAA1D321CF81CB41C891C')
                    # connection.send(b'441C231C201C1C1C2C1C371C5E1CF407E9080007F107F507FF07EF07F407F707FA07F607EE07EB07E607E807E207E707E207DF07E607EA07E307DF07DA07D807D407E307DB07D107CD07D107CF07C707C707D107C207CB07BF07BC07C107B807B107AD07AC07AC07AF07A207A907AD07A907A207A407A207A207A607A30796079A079B079B079907A0079708C0084008E008C007B007E008780880089008C008F008B808A80848084805D004600378024802400258024802480250023001400128012801380170019802D80458046004B004F804F805E00898089808F808580468046807A807A808B807F8082008380838083808380840085008500850085808500858087008780880087808900898089808A808A807F008C807B8080808780A9009880888089008900878087808880868086808600850084008380818081808180800080007B007B007900798079807A807A807A00730078809480B400B400B400998099809400950094806B8045803D004580460045803F803B803A8039803C003D8037002F002F0037803380838091808F80928093009300908092808F807A004B804D804700458045804580458045804580458045804780478048804E00560060805B0074007401018101813281328137813D013D01450155814C014C01648170815F81830183019781958198019801870187016C816601660161813C813')
                    # connection.send(b'C812A8120810100F200E100DC80DF00CB00D800B000B000AA80AA80B200AA00880057005800870087008580850045804600458043804380420041804080410041004200420042004680720095809C808D806C806C809300A480A480A800A800A700A600A700A700A700A880A800A800A880A900A900A980A880A980AA00AB00A980A980AA00AA00AA00AA00AB00AB80AB80AC00AB80AC00AC80AD00AD00AE00AE00AE80AE00AD00AE80AE00AD00AE00AE80AE80AE80AD80AF00AF00AE00AE00AE00AF00AE80AE80AE00AD80AD00AD00AC80AC80AC80AC80AD80AD80AC80AC80AC80AC80AD80AD80AE00AD80AD00AE00AF00AF00AF00B080B000B200B200B280B600B600B180B180B100B080B080B200B580B580B700B700B680B700B800B800B800B780B800B780B780B780B680B700B600B700B700B700B600B600B700B600B580B580B680B480B500B500B400B600B500B480B300B380B480B380B380B500B500B300B300B380B400B380B280B280B280B280B300B280B200B100B080B180B100AE80AF00AF00AD80AE80AE80AD00AD00AC809700970044003B0042006C808A00A700A700A500A480A280A2809700618061806F806C80760061004F804A8047004400428045804880528059805D804A804B80588084808A00890084807D007F006F807480558059005D006180648058004A804A004A0064806E00680068006')
                    # connection.send(b'F006C00640064805D00620065005C8057003F003D803D003C803D003D803C803D003C803D003D003D803E004100430047003A002A802800270027002D8039003C8037002A002B803000440050005A805A803B8032803F8043803E803B003600360048804780388041804780748059804800478040804C008680850079005E004A804B004B007800B8805')
                    # connection.send(b'7805380538050004F8056004F004E804E804E8058805E0054005400568056805C806480648064806F007880658070005D005F006480728067805700560056004F804E806380598065805B806480648060005F806300630077808100690069006780600065006F006D807300740074006E00828073808600888085808580798078007980750075007B8087008880888079807180700074007A00788079807780778077807C007C007C007D007D807A007C807E807C807D807D807F807F807F007E007C807C807E807E807780778075807400720071806E806D006D006A80670064806380568053805280590078808A008B808900898087807D809980940098008A8086008A808880958095809D00A000A080A400A780A800A780A780A600A600A480A380A40096809C808E0079007A004680468046804680468047004600460047004700470047804680480047804680470047004780478046004700470046804680470047004700470046804600468046804680460045804480448044004380440042804280418041804100408040003F803F8040803F803E803F003E003E003E003E003D003D803D803D803D803D003D003D003D804380470045004480438044004380438043804380438046004600458046004400440043804280400040004080400040003F803F003F003E003E003E003D80168016801E8020802B0026801')
                    # connection.send(b'2000D8019802B801E8029802C00240028002700268029802A8028802B802B802A802B002A802A802C002C802F003000318032803380340033803580350035002E00290026802400270034801280000000000000000000003180330031802D802300210018001D002D803500348036802F002B802B002A80300031802F002E80360036003600368035803600358036803600368037003700378037003700370034803800380038003780378037803800378037803800378037803800388035803800340034002500300036803780380039003A0026003780378037003F803E80410056004D804E004D804E004E0073804C004C004C004B804B8036803400310030803000468011002A802B002C002A0029802880280027802B000000000019002A802480118013803B003400108013800A800C000E80150016801880140013801B80138016803F001F003B00370037003A803B003B0038803900360039803A804080218021801C801C002B00370037003700328043802900380039803A0039803A00398039803980390038803880380037003680358037003780378037003880318033000000000000000000248024803500360036002D001A801E801D801E801E001F00208020802000208020002D800000000000000000000000002C801000330037003680378038803B803C003B003A803A803500278015001B80270029002')
                    # connection.send(b'A802C002D002F80318032003380348035003500360037003800388039803A003B003C003C003C803D803E003E8040004000410041804180428042804300430044004480448045004580460045804580468046804680460046804580458045804500450046004580468047004700470048804607B80\x03')
                
            except Exception as e:
                connection.close()
                print(e)
                break
    finally:
        # Clean up the connection
        connection.close()
